<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="ERforResearch">
<title>Demo ERforResearch • ERforResearch</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Demo ERforResearch">
<meta property="og:description" content="ERforResearch">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">ERforResearch</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">4.0.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/ERforResearch_vignette.html">Demo ERforResearch</a>
    <a class="dropdown-item" href="../articles/point_by_point_response.html">Point-by-Point Response Package Review</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Demo ERforResearch</h1>
                        <h4 data-toc-skip class="author">R. Heyard</h4>
            
      
      
      <div class="d-none name"><code>ERforResearch_vignette.Rmd</code></div>
    </div>

    
    
<p>The complex methodology of the ER is rather straightforward to use,
even without knowledge in building Bayesian hierarchical models. First,
for illustration, we will load a mock data set in <code>R</code>. The
function <code><a href="../reference/get_mock_data.html">get_mock_data()</a></code> does exactly that.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Load the mock data</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_mock_data.html">get_mock_data</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>The dataset comprises 3 different panels, with 5 voter and 15
proposals each. Every one of these voters gives a score to each of the
proposals. For the first illustrations, we will only use one panel
(<code>p1</code>).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data_panel1</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">panel</span> <span class="op">==</span> <span class="st">"p1"</span><span class="op">)</span></code></pre></div>
<p>The aim of this package is to be able to rank the proposals in a
certain call or panel. The most straightforward way to do this, is to
use the average of the scores a proposal received from all the
voters:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># First ranking based on simple means: </span>
<span class="va">data_panel1</span> <span class="op">%&gt;%</span> 
  <span class="fu">group_by</span><span class="op">(</span><span class="va">proposal</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">summarise</span><span class="op">(</span>avg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">num_grade</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">arrange</span><span class="op">(</span><span class="op">-</span><span class="va">avg</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## <span style="color: #949494;"># A tibble: 15 × 2</span></span>
<span class="co">##    proposal   avg</span>
<span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">## <span style="color: #BCBCBC;"> 1</span> #1         5  </span>
<span class="co">## <span style="color: #BCBCBC;"> 2</span> #2         4.6</span>
<span class="co">## <span style="color: #BCBCBC;"> 3</span> #3         4.6</span>
<span class="co">## <span style="color: #BCBCBC;"> 4</span> #4         4.6</span>
<span class="co">## <span style="color: #BCBCBC;"> 5</span> #5         4.4</span>
<span class="co">## <span style="color: #BCBCBC;"> 6</span> #6         4.2</span>
<span class="co">## <span style="color: #BCBCBC;"> 7</span> #7         4  </span>
<span class="co">## <span style="color: #BCBCBC;"> 8</span> #8         4  </span>
<span class="co">## <span style="color: #BCBCBC;"> 9</span> #9         3.8</span>
<span class="co">## <span style="color: #BCBCBC;">10</span> #10        3.6</span>
<span class="co">## <span style="color: #BCBCBC;">11</span> #11        3.4</span>
<span class="co">## <span style="color: #BCBCBC;">12</span> #12        3.2</span>
<span class="co">## <span style="color: #BCBCBC;">13</span> #13        2.8</span>
<span class="co">## <span style="color: #BCBCBC;">14</span> #14        2.8</span>
<span class="co">## <span style="color: #BCBCBC;">15</span> #15        2.6</span></code></pre>
<p>Let us assume, we had funding to accept five proposals in panel 1. In
this case, we would accept and fund the proposals #1-5, with average
scores ranging from 5 to 4.4. The methodology in the
<code>ERforResearch</code> package allows us to incorporate the
information on the voters behavior (are they more or less strict in
giving grades to proposals?). Additionally to that, the Bayesian
hierarchical models (BHM) can incorporate random variation in the
grading of the proposals, for example, due to conflict of interests or
other one proposal is not grades by every voter, (Note that here no
voter had a COI). This happens very regularly in the grant peer review
process. For this reason we will use a JAGS model via the
<code>rjags</code> package to build such a flexible model. The
<code>ERforResearch</code> package includes a function to call a default
JAGS BHM model:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">?</span><span class="fu">ERforResearch</span><span class="fu">::</span><span class="va"><a href="../reference/get_default_jags_model.html">get_default_jags_model</a></span></code></pre></div>
<p>Then, we have the possibility to simply use that default model and
sample from it using the <code><a href="../reference/get_mcmc_samples.html">get_mcmc_samples()</a></code> function.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># !Just for illustration purposes we set the rhat threshold a bit higher.</span>
<span class="co"># Make sure to leave it at the default value of 1.01 once the package-</span>
<span class="co"># functionalities are understood.</span>

<span class="co"># Estimate theta's </span>
<span class="va">mcmc_samples_object</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="../reference/get_mcmc_samples.html">get_mcmc_samples</a></span><span class="op">(</span>
    data <span class="op">=</span> <span class="va">data_panel1</span>, id_proposal <span class="op">=</span> <span class="st">"proposal"</span>,
    id_assessor <span class="op">=</span> <span class="st">"assessor"</span>,
    grade_variable <span class="op">=</span> <span class="st">"num_grade"</span>,
    path_to_jags_model <span class="op">=</span> <span class="cn">NULL</span>, 
          <span class="co"># NULL means we use the default model</span>
    seed <span class="op">=</span> <span class="fl">6</span>,
    rhat_threshold <span class="op">=</span> <span class="fl">1.05</span>,
    dont_bind <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] "Default model is used (check get_default_jags_model function!)."</span>
<span class="co">## Calling 4 simulations using the parallel method...</span>
<span class="co">## All chains have finished</span>
<span class="co">## Simulation complete.  Reading coda files...</span>
<span class="co">## Coda files loaded successfully</span>
<span class="co">## Note: Summary statistics were not produced as there are &gt;50 monitored</span>
<span class="co">## variables</span>
<span class="co">## [To override this behaviour see ?add.summary and ?runjags.options]</span>
<span class="co">## FALSEFinished running the simulation</span>
<span class="co">## Calculating summary statistics...</span>
<span class="co">## Calculating the Gelman-Rubin statistic for 108 variables....</span>
<span class="co">## [1] "Extension JAGS samples number 1."</span>
<span class="co">## Calling 4 simulations using the parallel method...</span>
<span class="co">## All chains have finished</span>
<span class="co">## Simulation complete.  Reading coda files...</span>
<span class="co">## Coda files loaded successfully</span>
<span class="co">## Note: Summary statistics were not produced as there are &gt;50 monitored</span>
<span class="co">## variables</span>
<span class="co">## [To override this behaviour see ?add.summary and ?runjags.options]</span>
<span class="co">## FALSEFinished running the simulation</span>
<span class="co">## Calculating summary statistics...</span>
<span class="co">## Calculating the Gelman-Rubin statistic for 108 variables....</span>
<span class="co">## Calculating summary statistics...</span>
<span class="co">## Calculating the Gelman-Rubin statistic for 108 variables....</span>
<span class="co">## Calculating summary statistics...</span>
<span class="co">## Calculating the Gelman-Rubin statistic for 108 variables....</span>
<span class="co">## Calculating summary statistics...</span>
<span class="co">## Calculating the Gelman-Rubin statistic for 108 variables....</span></code></pre>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># It took the model .... to converge:</span>
<span class="va">mcmc_samples_object</span><span class="op">$</span><span class="va">conv_status</span></code></pre></div>
<pre><code><span class="co">## [1] "Converged (with threshold set to 1.05)"</span></code></pre>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">mcmc_samples_object</span><span class="op">$</span><span class="va">n_adapt</span>, 
  <span class="va">mcmc_samples_object</span><span class="op">$</span><span class="va">n_burnin</span>,
  <span class="va">mcmc_samples_object</span><span class="op">$</span><span class="va">n_iter</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1]  1000  4000 20000</span></code></pre>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># With the latter object we can do some convergence diagnostics, </span>
<span class="fu">bayesplot</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/bayesplot/reference/MCMC-traces.html" class="external-link">mcmc_trace</a></span><span class="op">(</span><span class="va">mcmc_samples_object</span><span class="op">$</span><span class="va">samples</span><span class="op">$</span><span class="va">mcmc</span>,
                      pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"proposal_intercept["</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">15</span>, <span class="st">"]"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="ERforResearch_vignette_files/figure-html/unnamed-chunk-3-1.png" alt="Traceplots of the proposal effects." width="672"><p class="caption">
Traceplots of the proposal effects.
</p>
</div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Instead of the trace plots, we can directly look at the Summary in the object,</span>
<span class="co"># which includes the rhat values (psrf), Monte-Carlo error (MCerr) and the</span>
<span class="co"># effective sample size (SSeff) for each parameter, like so:</span>
<span class="co"># mcmc_samples_object$summary</span>

<span class="co"># If the model in path_to_jags_model is different from the default model with</span>
<span class="co"># different names for the specific parameters, this has to be declared in the </span>
<span class="co"># arguments (theta_name, tau_name, sigma_name, tau_voter_name, rank_theta_name).</span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># We can further produce rank histograms</span>
<span class="va">pl1</span> <span class="op">&lt;-</span> 
  <span class="fu">bayesplot</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/bayesplot/reference/MCMC-traces.html" class="external-link">mcmc_rank_hist</a></span><span class="op">(</span><span class="va">mcmc_samples_object</span><span class="op">$</span><span class="va">samples</span><span class="op">$</span><span class="va">mcmc</span>,
                            pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"proposal_intercept["</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">7</span>, <span class="st">"]"</span><span class="op">)</span><span class="op">)</span>
<span class="va">pl2</span> <span class="op">&lt;-</span> 
  <span class="fu">bayesplot</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/bayesplot/reference/MCMC-traces.html" class="external-link">mcmc_rank_hist</a></span><span class="op">(</span><span class="va">mcmc_samples_object</span><span class="op">$</span><span class="va">samples</span><span class="op">$</span><span class="va">mcmc</span>,
                            pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"proposal_intercept["</span>, <span class="fl">8</span><span class="op">:</span><span class="fl">15</span>, <span class="st">"]"</span><span class="op">)</span><span class="op">)</span>

<span class="va">pl1</span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="ERforResearch_vignette_files/figure-html/unnamed-chunk-4-1.png" alt="Rank histograms of the some parameters." width="672"><p class="caption">
Rank histograms of the some parameters.
</p>
</div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pl2</span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="ERforResearch_vignette_files/figure-html/unnamed-chunk-5-1.png" alt="Rank histograms of the some parameters (continued)." width="672"><p class="caption">
Rank histograms of the some parameters (continued).
</p>
</div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># For the further analyis we will simply use all three chains</span>
<span class="co"># and therefore bind them here.</span>
<span class="va">mcmc_samples</span> <span class="op">&lt;-</span> <span class="fu">coda</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.html" class="external-link">mcmc</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">mcmc_samples_object</span><span class="op">$</span><span class="va">samples</span><span class="op">$</span><span class="va">mcmc</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>We do not have to separately sample from the model, as the functions
that follow can easily call the <code><a href="../reference/get_mcmc_samples.html">get_mcmc_samples()</a></code>
themselves. If the same seed is given to the <code>seed</code> argument
in the respective functions the results are reproducible.</p>
<p>Then, we use the <code><a href="../reference/plot_rankogram.html">plot_rankogram()</a></code> function to plot the
<em>Rankograms</em> of each proposal, which are the probabilities of
each rank plotted against all possible ranks.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_rankogram.html">plot_rankogram</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data_panel1</span>,
               id_proposal <span class="op">=</span> <span class="st">"proposal"</span>,
               id_assessor <span class="op">=</span> <span class="st">"assessor"</span>,
               grade_variable <span class="op">=</span> <span class="st">"num_grade"</span>,
               mcmc_samples <span class="op">=</span> <span class="va">mcmc_samples_object</span>
                  <span class="co"># if NULL the `get_mcmc_samples function is called from within</span>
<span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="ERforResearch_vignette_files/figure-html/produce-rankogram-1.png" alt="Rankogram for the proposals on the first panel." width="672"><p class="caption">
Rankogram for the proposals on the first panel.
</p>
</div>
<p>Next, we can use the same function with the parameter
<code>cumulative_rank_prob</code> set to TRUE in order to plot the
cumulative ranking probabilities against the possible ranks.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_rankogram.html">plot_rankogram</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data_panel1</span>,
               id_proposal <span class="op">=</span> <span class="st">"proposal"</span>,
               id_assessor <span class="op">=</span> <span class="st">"assessor"</span>,
               grade_variable <span class="op">=</span> <span class="st">"num_grade"</span>,
               cumulative_rank_prob <span class="op">=</span> <span class="cn">TRUE</span>,
               mcmc_samples <span class="op">=</span> <span class="va">mcmc_samples_object</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="ERforResearch_vignette_files/figure-html/produce-cumulative-ranking-probabilities-1.png" alt="Cumulative ranking probability plots for competing proposals in the first panel." width="672"><p class="caption">
Cumulative ranking probability plots for competing proposals in the
first panel.
</p>
</div>
<p>The SUCRA is the area under the cumulative ranking probability plot.
The higher the SUCRA value, the higher the likelihood of a proposal
being in the top rank or one of the top ranks.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">SUCRA_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_sucra.html">get_sucra</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data_panel1</span>,
                           id_proposal <span class="op">=</span> <span class="st">"proposal"</span>,
                           id_assessor <span class="op">=</span> <span class="st">"assessor"</span>,
                           grade_variable <span class="op">=</span> <span class="st">"num_grade"</span>,
                           mcmc_samples <span class="op">=</span> <span class="va">mcmc_samples_object</span><span class="op">)</span>
<span class="va">SUCRA_results</span><span class="op">$</span><span class="va">sucra</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">##   #1   #2   #3   #4   #5   #6   #7   #8   #9  #10  #11  #12  #13  #14  #15 </span>
<span class="co">## 0.90 0.78 0.78 0.78 0.71 0.63 0.55 0.55 0.47 0.40 0.33 0.25 0.15 0.14 0.09</span></code></pre>
<p>Finally we will compute the expected ranks (ER), which can directly
be linked to the SUCRA. The lower the ER the better the evaluation of
the proposal. The best possible ER is 1 for rank 1.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ER_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_er_from_jags.html">get_er_from_jags</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data_panel1</span>,
                               id_proposal <span class="op">=</span> <span class="st">"proposal"</span>,
                               id_assessor <span class="op">=</span> <span class="st">"assessor"</span>,
                               grade_variable <span class="op">=</span> <span class="st">"num_grade"</span>,
                               mcmc_samples <span class="op">=</span> <span class="va">mcmc_samples_object</span><span class="op">)</span>

<span class="va">ER_results</span><span class="op">$</span><span class="va">rankings</span> <span class="op">%&gt;%</span> 
  <span class="fu">mutate_if</span><span class="op">(</span><span class="va">is.numeric</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">arrange</span><span class="op">(</span><span class="va">er</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## <span style="color: #949494;"># A tibble: 15 × 6</span></span>
<span class="co">##    id_proposal  rank avg_grade    er rank_pm  pcer</span>
<span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">## <span style="color: #BCBCBC;"> 1</span> #1            1         5    2.44       1  12.9</span>
<span class="co">## <span style="color: #BCBCBC;"> 2</span> #2            3         4.6  4.06       2  23.7</span>
<span class="co">## <span style="color: #BCBCBC;"> 3</span> #3            3         4.6  4.09       3  24.0</span>
<span class="co">## <span style="color: #BCBCBC;"> 4</span> #4            3         4.6  4.12       4  24.2</span>
<span class="co">## <span style="color: #BCBCBC;"> 5</span> #5            5         4.4  5.08       5  30.6</span>
<span class="co">## <span style="color: #BCBCBC;"> 6</span> #6            6         4.2  6.19       6  37.9</span>
<span class="co">## <span style="color: #BCBCBC;"> 7</span> #8            7.5       4    7.26       7  45.1</span>
<span class="co">## <span style="color: #BCBCBC;"> 8</span> #7            7.5       4    7.34       8  45.6</span>
<span class="co">## <span style="color: #BCBCBC;"> 9</span> #9            9         3.8  8.43       9  52.9</span>
<span class="co">## <span style="color: #BCBCBC;">10</span> #10          10         3.6  9.42      10  59.4</span>
<span class="co">## <span style="color: #BCBCBC;">11</span> #11          11         3.4 10.4       11  66.3</span>
<span class="co">## <span style="color: #BCBCBC;">12</span> #12          12         3.2 11.4       12  73.0</span>
<span class="co">## <span style="color: #BCBCBC;">13</span> #13          13.5       2.8 13.0       13  83.1</span>
<span class="co">## <span style="color: #BCBCBC;">14</span> #14          13.5       2.8 13.0       14  83.6</span>
<span class="co">## <span style="color: #BCBCBC;">15</span> #15          15         2.6 13.7       15  87.9</span></code></pre>
<p>The latter, can also be plotted using the
<code>plotting_er_results</code> function. As can be seen in the figure,
the five best proposals are still the same, but the ordering of all
proposals changed. The ER actually does a comparative ranking, by
comparing every proposal to every other proposal.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plotting_er_results.html">plotting_er_results</a></span><span class="op">(</span><span class="va">ER_results</span>, title <span class="op">=</span> <span class="st">"Panel 1"</span>, how_many_fundable <span class="op">=</span> <span class="fl">5</span>,
                    draw_funding_line <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## Warning: attributes are not identical across measure variables;</span>
<span class="co">## they will be dropped</span></code></pre>
<div class="figure" style="text-align: center">
<img src="ERforResearch_vignette_files/figure-html/er-plot-1.png" alt="All proposals from the first mock panel ranked using the average grade (Fixed), the posterior means (Posterior Mean) and the expected rank (ER)." width="672"><p class="caption">
All proposals from the first mock panel ranked using the average grade
(Fixed), the posterior means (Posterior Mean) and the expected rank
(ER).
</p>
</div>
<p>To better see, whether the funding line (FL) (here: between the fifth
and the sixth proposal) goes through a cluster, we use the posterior
distribution of the ER. The ERs of the competing proposals are plotted
together with their 50% credible intervals (CrI). A provisional FL is
defined at the ER of the last fundable (here the fifth) proposal. The
proposals with a 50% CrI not crossing the FL are directly accecpted or
rejected, depending whether their ER is lower or higher than the FL. The
proposals with a 50% CrI crossing the FL will constitute the random
selection group. In the case of panel 1 of the mock data four proposals
will be randomly selected from a group of five.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_er_distributions.html">plot_er_distributions</a></span><span class="op">(</span><span class="va">mcmc_samples_object</span>, 
                      n_proposals <span class="op">=</span> <span class="va">data_panel1</span> <span class="op">%&gt;%</span>
                        <span class="fu">summarise</span><span class="op">(</span>n <span class="op">=</span> <span class="fu">n_distinct</span><span class="op">(</span><span class="va">proposal</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">pull</span><span class="op">(</span><span class="op">)</span>, 
                      number_fundable <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="ERforResearch_vignette_files/figure-html/clustered-er-plot-1.png" alt="All proposals from the first mock panel ranked by their ER together with their 50% credible intervals (inner band) and 90% credible intervals (outer band)." width="672"><p class="caption">
All proposals from the first mock panel ranked by their ER together with
their 50% credible intervals (inner band) and 90% credible intervals
(outer band).
</p>
</div>
<p>The flexibility of the method of the ER allows us to not only look at
the panels individually but also rank all the proposals from the three
panels in one large ranking. To do this, we can simply use the default
model, but have to give a parameter for <code>id_section</code>.</p>
<pre><code><span class="co">## model{</span>
<span class="co">##       # Likelihood:</span>
<span class="co">##       for (i in 1:n) { # i is not the application but the review</span>
<span class="co">##           grade[i] ~ dnorm(mu[i], inv_sigma2)</span>
<span class="co">##                 # inv_sigma2 is precision (1 / variance)</span>
<span class="co">##           mu[i] &lt;- overall_mean + proposal_intercept[num_proposal[i]] +</span>
<span class="co">##           assessor_intercept[num_assessor[i]] + panel_intercept[num_panel[i]]</span>
<span class="co">##       }</span>
<span class="co">##       # Ranks:</span>
<span class="co">##       rank_theta[1:n_proposal] &lt;- rank(-proposal_intercept[])</span>
<span class="co">##       # Priors:</span>
<span class="co">##       for (j in 1:n_proposal){</span>
<span class="co">##         proposal_intercept[j] ~ dnorm(0, inv_tau_proposal2)</span>
<span class="co">##       }</span>
<span class="co">##       for (l in 1:n_assessors){</span>
<span class="co">##         assessor_intercept[l] ~ dnorm(nu[l], inv_tau_assessor2)</span>
<span class="co">##       }</span>
<span class="co">##       for (l in 1:n_assessors){</span>
<span class="co">##         nu[l] ~ dnorm(0, 100) # 1/(0.1^2) = 100</span>
<span class="co">##       }</span>
<span class="co">##       for (l in 1:n_panels){</span>
<span class="co">##         panel_intercept[l] ~ dnorm(0, inv_tau_panel2)</span>
<span class="co">##       }</span>
<span class="co">##       sigma ~ dunif(0.000001, 2)</span>
<span class="co">##       inv_sigma2 &lt;- pow(sigma, -2)</span>
<span class="co">##       inv_tau_proposal2 &lt;- pow(tau_proposal, -2)</span>
<span class="co">##       tau_proposal ~ dunif(0.000001, 2)</span>
<span class="co">##       inv_tau_assessor2 &lt;- pow(tau_assessor, -2)</span>
<span class="co">##       tau_assessor ~ dunif(0.000001, 2)</span>
<span class="co">##       inv_tau_panel2 &lt;- pow(tau_panel, -2)</span>
<span class="co">##       tau_panel ~ dunif(0.000001, 2)</span>
<span class="co">##     }</span></code></pre>
<p>Then we use the latter model to directly plot the ER:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ER_results_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_er_from_jags.html">get_er_from_jags</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data</span>,
                                   id_proposal <span class="op">=</span> <span class="st">"proposal"</span>,
                                   id_assessor <span class="op">=</span> <span class="st">"assessor"</span>,
                                   id_panel <span class="op">=</span> <span class="st">"panel"</span>,
                                   grade_variable <span class="op">=</span> <span class="st">"num_grade"</span>,
                                   tau_name_panel <span class="op">=</span> <span class="st">"tau_panel"</span>,
                                   n_chains <span class="op">=</span> <span class="fl">4</span>, n_iter <span class="op">=</span> <span class="fl">5000</span>,
                                   n_burnin <span class="op">=</span> <span class="fl">1000</span>, n_adapt <span class="op">=</span> <span class="fl">1000</span>,
                                   rhat_threshold <span class="op">=</span> <span class="fl">1.1</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] "Default model is used (check get_default_jags_model function!)."</span>
<span class="co">## Calling 4 simulations using the parallel method...</span>
<span class="co">## All chains have finished</span>
<span class="co">## Simulation complete.  Reading coda files...</span>
<span class="co">## Coda files loaded successfully</span>
<span class="co">## Note: Summary statistics were not produced as there are &gt;50 monitored</span>
<span class="co">## variables</span>
<span class="co">## [To override this behaviour see ?add.summary and ?runjags.options]</span>
<span class="co">## FALSEFinished running the simulation</span>
<span class="co">## Calculating summary statistics...</span>
<span class="co">## Calculating the Gelman-Rubin statistic for 769 variables....</span>
<span class="co">## [1] "Extension JAGS samples number 1."</span>
<span class="co">## Calling 4 simulations using the parallel method...</span>
<span class="co">## All chains have finished</span>
<span class="co">## Simulation complete.  Reading coda files...</span>
<span class="co">## Coda files loaded successfully</span>
<span class="co">## Note: Summary statistics were not produced as there are &gt;50 monitored</span>
<span class="co">## variables</span>
<span class="co">## [To override this behaviour see ?add.summary and ?runjags.options]</span>
<span class="co">## FALSEFinished running the simulation</span>
<span class="co">## Calculating summary statistics...</span>
<span class="co">## Calculating the Gelman-Rubin statistic for 769 variables....</span>
<span class="co">## Calculating summary statistics...</span>
<span class="co">## Calculating the Gelman-Rubin statistic for 769 variables....</span>
<span class="co">## Calculating summary statistics...</span>
<span class="co">## Calculating the Gelman-Rubin statistic for 769 variables....</span>
<span class="co">## Calculating summary statistics...</span>
<span class="co">## Calculating the Gelman-Rubin statistic for 769 variables....</span></code></pre>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plotting_er_results.html">plotting_er_results</a></span><span class="op">(</span><span class="va">ER_results_all</span>, title <span class="op">=</span> <span class="st">"All three panels"</span>,
                    draw_funding_line <span class="op">=</span> <span class="cn">FALSE</span>,
                    how_many_fundable <span class="op">=</span> <span class="fl">15</span><span class="op">)</span>  </code></pre></div>
<pre><code><span class="co">## Warning: attributes are not identical across measure variables;</span>
<span class="co">## they will be dropped</span></code></pre>
<div class="figure" style="text-align: center">
<img src="ERforResearch_vignette_files/figure-html/er-plot-all-1.png" alt="The proposals from all mock panels ranked using the average grade (Fixed), the posterior means (Posterior Mean) and the expected rank (ER)." width="672"><p class="caption">
The proposals from all mock panels ranked using the average grade
(Fixed), the posterior means (Posterior Mean) and the expected rank
(ER).
</p>
</div>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Rachel Heyard.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
